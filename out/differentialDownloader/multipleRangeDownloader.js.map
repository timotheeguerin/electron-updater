{"version":3,"sources":["../../src/differentialDownloader/multipleRangeDownloader.ts"],"names":[],"mappings":"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","sourcesContent":["import { createHttpError, safeGetHeader } from \"builder-util-runtime\"\r\nimport { IncomingMessage } from \"http\"\r\nimport { Writable } from \"stream\"\r\nimport { copyData, DataSplitter, PartListDataTask } from \"./DataSplitter\"\r\nimport { DifferentialDownloader } from \"./DifferentialDownloader\"\r\nimport { Operation, OperationKind } from \"./downloadPlanBuilder\"\r\n\r\nexport function executeTasks(differentialDownloader: DifferentialDownloader, tasks: Array<Operation>, out: Writable, oldFileFd: number, reject: (error: Error) => void) {\r\n  const w = (taskOffset: number) => {\r\n    if (taskOffset >= tasks.length) {\r\n      if (differentialDownloader.fileMetadataBuffer != null) {\r\n        out.write(differentialDownloader.fileMetadataBuffer)\r\n      }\r\n      out.end()\r\n      return\r\n    }\r\n\r\n    const nextOffset = taskOffset + (differentialDownloader.options.useMultipleRangeRequest === false ? 1 : 1000)\r\n    _executeTasks(differentialDownloader, {\r\n      tasks,\r\n      start: taskOffset,\r\n      end: Math.min(tasks.length, nextOffset),\r\n      oldFileFd,\r\n    }, out, () => w(nextOffset), reject)\r\n  }\r\n  return w\r\n}\r\n\r\nexport function _executeTasks(differentialDownloader: DifferentialDownloader, options: PartListDataTask, out: Writable, resolve: () => void, reject: (error: Error) => void) {\r\n  let ranges = \"bytes=\"\r\n  let partCount = 0\r\n  const partIndexToTaskIndex = new Map<number, number>()\r\n  const partIndexToLength: Array<number> = []\r\n  for (let i = options.start; i < options.end; i++) {\r\n    const task = options.tasks[i]\r\n    if (task.kind === OperationKind.DOWNLOAD) {\r\n      ranges += `${task.start}-${task.end - 1}, `\r\n      partIndexToTaskIndex.set(partCount, i)\r\n      partCount++\r\n      partIndexToLength.push(task.end - task.start)\r\n    }\r\n  }\r\n\r\n  if (partCount <= 1) {\r\n    // the only remote range - copy\r\n    const w = (index: number) => {\r\n      if (index >= options.end) {\r\n        resolve()\r\n        return\r\n      }\r\n\r\n      const task = options.tasks[index++]\r\n\r\n      if (task.kind === OperationKind.COPY) {\r\n        copyData(task, out, options.oldFileFd, reject, () => w(index))\r\n      }\r\n      else {\r\n        const requestOptions = differentialDownloader.createRequestOptions(\"get\")\r\n        requestOptions.headers!!.Range = `bytes=${task.start}-${task.end - 1}`\r\n        const request = differentialDownloader.httpExecutor.doRequest(requestOptions, response => {\r\n          if (!checkIsRangesSupported(response, reject)) {\r\n            return\r\n          }\r\n\r\n          response.pipe(out, {\r\n            end: false\r\n          })\r\n          response.once(\"end\", () => w(index))\r\n        })\r\n        differentialDownloader.httpExecutor.addErrorAndTimeoutHandlers(request, reject)\r\n        request.end()\r\n      }\r\n    }\r\n\r\n    w(options.start)\r\n    return\r\n  }\r\n\r\n  const requestOptions = differentialDownloader.createRequestOptions(\"get\")\r\n  requestOptions.headers!!.Range = ranges.substring(0, ranges.length - 2)\r\n  const request = differentialDownloader.httpExecutor.doRequest(requestOptions, response => {\r\n    if (!checkIsRangesSupported(response, reject)) {\r\n      return\r\n    }\r\n\r\n    const contentType = safeGetHeader(response, \"content-type\")\r\n    const m = /^multipart\\/.+?(?:; boundary=(?:(?:\"(.+)\")|(?:([^\\s]+))))$/i.exec(contentType)\r\n    if (m == null) {\r\n      reject(new Error(`Content-Type \"multipart/byteranges\" is expected, but got \"${contentType}\"`))\r\n      return\r\n    }\r\n\r\n    const dicer = new DataSplitter(out, options, partIndexToTaskIndex, m[1] || m[2], partIndexToLength, resolve)\r\n    dicer.on(\"error\", reject)\r\n    response.pipe(dicer)\r\n  })\r\n  differentialDownloader.httpExecutor.addErrorAndTimeoutHandlers(request, reject)\r\n  request.end()\r\n}\r\n\r\nexport function checkIsRangesSupported(response: IncomingMessage, reject: (error: Error) => void): boolean {\r\n  // Electron net handles redirects automatically, our NodeJS test server doesn't use redirects - so, we don't check 3xx codes.\r\n  if (response.statusCode!! >= 400) {\r\n    reject(createHttpError(response))\r\n    return false\r\n  }\r\n\r\n  if (response.statusCode !== 206) {\r\n    const acceptRanges = safeGetHeader(response, \"accept-ranges\")\r\n    if (acceptRanges == null || acceptRanges === \"none\") {\r\n      reject(new Error(`Server doesn't support Accept-Ranges (response code ${response.statusCode})`))\r\n      return false\r\n    }\r\n  }\r\n  return true\r\n}"],"sourceRoot":""}
