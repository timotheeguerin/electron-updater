{"version":3,"sources":["../../src/providers/PrivateGitHubProvider.ts"],"names":[],"mappings":"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","sourcesContent":["import { CancellationToken, GithubOptions, HttpError, HttpExecutor, newError, UpdateInfo } from \"builder-util-runtime\"\r\nimport { OutgoingHttpHeaders, RequestOptions } from \"http\"\r\nimport { safeLoad } from \"js-yaml\"\r\nimport * as path from \"path\"\r\nimport { AppUpdater } from \"../AppUpdater\"\r\nimport { URL } from \"url\"\r\nimport { BaseGitHubProvider } from \"./GitHubProvider\"\r\nimport { getChannelFilename, getDefaultChannelName, newUrlFromBase, ResolvedUpdateFileInfo } from \"../main\"\r\nimport { getFileList } from \"./Provider\"\r\n\r\nexport interface PrivateGitHubUpdateInfo extends UpdateInfo {\r\n  assets: Array<Asset>\r\n}\r\n\r\nexport class PrivateGitHubProvider extends BaseGitHubProvider<PrivateGitHubUpdateInfo> {\r\n  constructor(options: GithubOptions, private readonly updater: AppUpdater, private readonly token: string, executor: HttpExecutor<any>) {\r\n    super(options, \"api.github.com\", executor)\r\n  }\r\n\r\n  protected createRequestOptions(url: URL, headers?: OutgoingHttpHeaders | null): RequestOptions {\r\n    const result = super.createRequestOptions(url, headers);\r\n    (result as any).redirect = \"manual\"\r\n    return result\r\n  }\r\n\r\n  async getLatestVersion(): Promise<PrivateGitHubUpdateInfo> {\r\n    const cancellationToken = new CancellationToken()\r\n    const channelFile = getChannelFilename(getDefaultChannelName())\r\n\r\n    const releaseInfo = await this.getLatestVersionInfo(cancellationToken)\r\n    const asset = releaseInfo.assets.find(it => it.name === channelFile)\r\n    if (asset == null) {\r\n      // html_url must be always, but just to be sure\r\n      throw newError(`Cannot find ${channelFile} in the release ${releaseInfo.html_url || releaseInfo.name}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\r\n    }\r\n\r\n    const url = new URL(asset.url)\r\n    let result: any\r\n    try {\r\n      result = safeLoad((await this.httpRequest(url, this.configureHeaders(\"application/octet-stream\"), cancellationToken))!!)\r\n    }\r\n    catch (e) {\r\n      if (e instanceof HttpError && e.statusCode === 404) {\r\n        throw newError(`Cannot find ${channelFile} in the latest release artifacts (${url}): ${e.stack || e.message}`, \"ERR_UPDATER_CHANNEL_FILE_NOT_FOUND\")\r\n      }\r\n      throw e\r\n    }\r\n\r\n    (result as PrivateGitHubUpdateInfo).assets = releaseInfo.assets\r\n    return result\r\n  }\r\n\r\n  get fileExtraDownloadHeaders(): OutgoingHttpHeaders | null {\r\n    return this.configureHeaders(\"application/octet-stream\")\r\n  }\r\n\r\n  private configureHeaders(accept: string) {\r\n    return {\r\n      accept,\r\n      authorization: `token ${this.token}`,\r\n    }\r\n  }\r\n\r\n  private async getLatestVersionInfo(cancellationToken: CancellationToken): Promise<ReleaseInfo> {\r\n    let basePath = this.basePath\r\n    const allowPrerelease = this.updater.allowPrerelease\r\n\r\n    if (!allowPrerelease) {\r\n      basePath = `${basePath}/latest`\r\n    }\r\n\r\n    const url = newUrlFromBase(basePath, this.baseUrl)\r\n    try {\r\n      let version = (JSON.parse((await this.httpRequest(url, this.configureHeaders(\"application/vnd.github.v3+json\"), cancellationToken))!!))\r\n      if (allowPrerelease) {\r\n        version = version.find((v: any) => v.prerelease)\r\n      }\r\n      return version\r\n    }\r\n    catch (e) {\r\n      throw newError(`Unable to find latest version on GitHub (${url}), please ensure a production release exists: ${e.stack || e.message}`, \"ERR_UPDATER_LATEST_VERSION_NOT_FOUND\")\r\n    }\r\n  }\r\n\r\n  private get basePath() {\r\n    return this.computeGithubBasePath(`/repos/${this.options.owner}/${this.options.repo}/releases`)\r\n  }\r\n\r\n  resolveFiles(updateInfo: PrivateGitHubUpdateInfo): Array<ResolvedUpdateFileInfo> {\r\n    return getFileList(updateInfo).map(it => {\r\n      const name = path.posix.basename(it.url).replace(/ /g, \"-\")\r\n      const asset = updateInfo.assets.find(it => it != null && it.name === name)\r\n      if (asset == null) {\r\n        throw newError(`Cannot find asset \"${name}\" in: ${JSON.stringify(updateInfo.assets, null, 2)}`, \"ERR_UPDATER_ASSET_NOT_FOUND\")\r\n      }\r\n\r\n      return {\r\n        url: new URL(asset.url),\r\n        info: it,\r\n      }\r\n    })\r\n  }\r\n}\r\n\r\ninterface ReleaseInfo {\r\n  name: string\r\n  html_url: string\r\n  assets: Array<Asset>\r\n}\r\n\r\nexport interface Asset {\r\n  name: string\r\n  url: string\r\n}"],"sourceRoot":""}
